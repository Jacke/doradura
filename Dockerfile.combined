# Build stage for Rust application
FROM rust:1.85-alpine AS rust-builder

RUN apk add --no-cache \
  musl-dev \
  pkgconfig \
  openssl-dev \
  openssl-libs-static \
  sqlite-dev \
  sqlite-static \
  build-base

WORKDIR /app

COPY Cargo.toml Cargo.lock ./
COPY build.rs ./
COPY c_code ./c_code
COPY src ./src
COPY locales ./locales
COPY migrations ./migrations

RUN cargo build --release && \
  echo "Binary built successfully:" && \
  ls -lh /app/target/release/doradura && \
  file /app/target/release/doradura && \
  ldd /app/target/release/doradura || echo "Static binary (no dynamic libs)"

# Runtime stage - based on aiogram/telegram-bot-api
FROM aiogram/telegram-bot-api:latest

USER root

# Install runtime dependencies for the bot
RUN apk add --no-cache \
  ca-certificates \
  musl \
  libssl3 \
  libcrypto3 \
  ffmpeg \
  python3 \
  py3-pip \
  sqlite-libs \
  libgcc \
  libstdc++ \
  wget \
  curl \
  unzip \
  bash \
  supervisor \
  nodejs \
  git

# Install Chromium and display server for cookie management
RUN apk add --no-cache \
  chromium \
  chromium-chromedriver \
  nss \
  freetype \
  harfbuzz \
  ttf-freefont \
  font-noto \
  xorg-server \
  xvfb-run \
  x11vnc \
  py3-aiohttp \
  # Build dependencies for canvas (bgutil PO Token server)
  build-base \
  pkgconfig \
  cairo-dev \
  pango-dev \
  jpeg-dev \
  giflib-dev \
  pixman-dev

# Install noVNC (web-based VNC client for first-time login)
RUN mkdir -p /opt/novnc && \
  wget -qO- https://github.com/novnc/noVNC/archive/refs/tags/v1.5.0.tar.gz | \
  tar xz -C /opt/novnc --strip-components=1 && \
  ln -s /opt/novnc/vnc_lite.html /opt/novnc/index.html

# Node.js 22+ is already installed (required for yt-dlp YouTube n-challenge solving)
RUN node --version && echo "Node.js available for yt-dlp --js-runtimes node"

# Install npm (for bgutil PO Token provider)
RUN apk add --no-cache npm

# Install yt-dlp from nightly builds (latest fixes for YouTube compatibility)
RUN wget --progress=dot:giga https://github.com/yt-dlp/yt-dlp-nightly-builds/releases/latest/download/yt-dlp -O /usr/local/bin/yt-dlp && \
  chmod a+rx /usr/local/bin/yt-dlp

# Install Python dependencies (including yt-dlp PO Token plugin)
RUN pip3 install --no-cache-dir --break-system-packages \
  keyring pycryptodomex websockify undetected-chromedriver bgutil-ytdlp-pot-provider

# Install bgutil PO Token HTTP server (generates tokens for yt-dlp)
# This server runs BotGuard JavaScript via Node.js to generate valid PO tokens
RUN mkdir -p /opt/bgutil && \
  cd /opt/bgutil && \
  git clone --single-branch --branch 1.2.2 https://github.com/Brainicism/bgutil-ytdlp-pot-provider.git . && \
  cd server && \
  npm install && \
  npx tsc && \
  echo "âœ… bgutil PO Token server built successfully"

# Create shared group and users, then set up directories
# Both telegram-bot-api and botuser need to share files via shareddata group
RUN addgroup -g 2000 shareddata && \
  adduser -D -u 1000 -G shareddata botuser && \
  addgroup telegram-bot-api shareddata && \
  addgroup botuser telegram-bot-api && \
  mkdir -p /app /data && \
  chown 1000:2000 /app && \
  chown telegram-bot-api:shareddata /data && \
  chmod 775 /data && \
  cp /usr/bin/chromedriver /home/botuser/chromedriver && \
  chown 1000:2000 /home/botuser/chromedriver && \
  chmod 755 /home/botuser/chromedriver

# Copy the compiled binary from rust-builder and set permissions
COPY --from=rust-builder --chown=1000:2000 /app/target/release/doradura /app/doradura
RUN chmod 755 /app/doradura && \
  ls -la /app/doradura

# Copy migrations for auto-migration on startup
COPY --from=rust-builder --chown=1000:2000 /app/migrations /app/migrations

# Copy cookie manager script
COPY --chown=1000:2000 tools/cookie_manager.py /app/cookie_manager.py

# Set environment variables for the bot to access Bot API files
ENV BOT_API_DATA_DIR=/data
ENV BOT_API_URL=http://localhost:8081

# Create bot wrapper script that runs as root to fix permissions, then drops to botuser
RUN cat > /app/run-bot.sh << 'BOT_WRAPPER_EOF'
#!/bin/sh
# Fix /data permissions (this wrapper runs as root, then switches to botuser)
chmod 775 /data
cd /data
# Switch to botuser and run the bot
BOT_API="${BOT_API_URL:-http://localhost:8081}"
exec su -s /bin/sh botuser -c "export DATABASE_URL=/data/database.sqlite TEMP_FILES_DIR=/data BOT_API_DATA_DIR=/data BOT_API_URL=$BOT_API LOG_FILE_PATH=/data/app.log && exec /app/doradura"
BOT_WRAPPER_EOF

RUN chmod +x /app/run-bot.sh && chown root:root /app/run-bot.sh

# Create supervisor configuration directory and config file
RUN mkdir -p /etc/supervisor/conf.d && \
  cat > /etc/supervisor/conf.d/supervisord.conf << 'SUPERVISOR_EOF'
[supervisord]
nodaemon=true
user=root
logfile=/dev/stdout
logfile_maxbytes=0
pidfile=/var/run/supervisord.pid

[program:telegram-bot-api]
command=/bin/sh -c "umask 007 && telegram-bot-api --local --api-id=${TELEGRAM_API_ID} --api-hash=${TELEGRAM_API_HASH} --http-port=8081 --http-stat-port=8082 --dir=/data --temp-dir=/tmp --verbosity=1"
user=telegram-bot-api
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=10

[program:cookie-manager]
command=python3 /app/cookie_manager.py
user=botuser
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=15
environment=DISPLAY=":99",HOME="/home/botuser",CHROMEDRIVER_PATH="/home/botuser/chromedriver"

[program:bgutil-pot-server]
command=node /opt/bgutil/server/build/main.js
user=botuser
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=12
environment=HOME="/home/botuser",TOKEN_TTL="6"

[program:doradura-bot]
command=/app/run-bot.sh
user=root
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=20
SUPERVISOR_EOF

# Create entrypoint script
RUN cat > /entrypoint.sh << 'ENTRYPOINT_EOF'
#!/bin/bash
set -e

echo "================================================"
echo "Starting Combined Telegram Bot API + Doradura Bot"
echo "================================================"

# Create directories with correct permissions
mkdir -p /data /tmp
chmod 1777 /tmp

# Set ownership and permissions for /data
if id telegram-bot-api >/dev/null 2>&1 && getent group shareddata >/dev/null 2>&1; then
chown telegram-bot-api:shareddata /data
chmod 775 /data
echo "âœ… /data ownership: $(ls -ld /data)"
fi

# Ensure app directory is owned by botuser (UID:GID = 1000:2000)
if id botuser >/dev/null 2>&1; then
chown -R 1000:2000 /app
chmod 755 /app
echo "âœ… /app ownership: $(ls -ld /app)"
fi

# Verify binary exists and is executable
if [ -f /app/doradura ]; then
echo "âœ… Binary found: $(ls -lh /app/doradura)"
else
echo "âŒ ERROR: /app/doradura not found!"
exit 1
fi

# Set default temp files directory
export TEMP_FILES_DIR="${TEMP_FILES_DIR:-/data}"

# Database setup
DB_PATH=${DATABASE_URL:-/data/database.sqlite}
DB_DIR=$(dirname "$DB_PATH")
mkdir -p "$DB_DIR"
chmod 755 "$DB_DIR" || true
export DATABASE_URL="$DB_PATH"

echo "âœ… Telegram Bot API directory: /data"
echo "âœ… Database: $DB_PATH"
echo "âœ… Temp files: $TEMP_FILES_DIR"

# Run database migrations
echo "ðŸ”„ Running database migrations..."
MIGRATIONS_DIR="/app/migrations"
if [ -d "$MIGRATIONS_DIR" ]; then
  for migration in $(ls -1 "$MIGRATIONS_DIR"/*.sql 2>/dev/null | sort -V); do
    migration_name=$(basename "$migration")
    echo "  Applying: $migration_name"
    if sqlite3 "$DB_PATH" < "$migration" 2>&1; then
      echo "  âœ… $migration_name applied"
    else
      echo "  âš ï¸  $migration_name (already applied or error)"
    fi
  done
  echo "âœ… Migrations complete"
else
  echo "âš ï¸  No migrations directory found"
fi

# Write YouTube cookies from env if provided (base64)
if [ -n "$YTDL_COOKIES_B64" ]; then
COOKIES_PATH=${YTDL_COOKIES_FILE:-/data/youtube_cookies.txt}
COOKIES_DIR=$(dirname "$COOKIES_PATH")
mkdir -p "$COOKIES_DIR"
echo "$YTDL_COOKIES_B64" | base64 -d > "$COOKIES_PATH"
if id botuser >/dev/null 2>&1; then
chown 1000:2000 "$COOKIES_PATH"
fi
chmod 644 "$COOKIES_PATH"
export YTDL_COOKIES_FILE="$COOKIES_PATH"
echo "âœ… YouTube cookies written to $COOKIES_PATH"
fi

echo "================================================"
echo "Starting services via supervisor..."
echo "================================================"

# Start supervisor (manages both Bot API and doradura bot)
exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
ENTRYPOINT_EOF

RUN chmod +x /entrypoint.sh

# Expose ports (8080=webapp, 8081=bot-api, 8082=bot-api-stats, 6080=noVNC)
EXPOSE 6080 8080 8081 8082

# Health check for both services
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD pgrep telegram-bot-api && pgrep doradura || exit 1

ENTRYPOINT ["/entrypoint.sh"]
