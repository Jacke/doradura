# Prometheus Alert Rules for Doradura Bot

groups:
  - name: doradura_bot_alerts
    interval: 30s
    rules:
      # ========================================
      # CRITICAL ALERTS
      # ========================================

      # High error rate
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(doradura_download_failure_total[5m]))
            /
            sum(rate(doradura_download_success_total[5m]) + rate(doradura_download_failure_total[5m]))
          ) * 100 > 10
        for: 5m
        labels:
          severity: critical
          component: downloads
        annotations:
          summary: "High download error rate detected"
          description: "Error rate is {{ $value | humanize }}% (threshold: 10%)"

      # Queue is backed up
      - alert: QueueBackup
        expr: doradura_queue_depth > 100
        for: 5m
        labels:
          severity: critical
          component: queue
        annotations:
          summary: "Download queue is backing up"
          description: "Queue depth is {{ $value }} tasks (threshold: 100)"

      # Bot is not working (no metrics)
      - alert: BotDown
        expr: up{job="doradura-bot"} == 0
        for: 2m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Doradura bot is down"
          description: "Bot has been unreachable for 2 minutes"

      # yt-dlp is not working
      - alert: YtdlpFailures
        expr: |
          sum(rate(doradura_errors_total{category="ytdlp"}[5m])) > 0.5
        for: 3m
        labels:
          severity: critical
          component: ytdlp
        annotations:
          summary: "yt-dlp is experiencing failures"
          description: "yt-dlp error rate: {{ $value | humanize }} errors/sec"

      # ========================================
      # WARNING ALERTS
      # ========================================

      # Slow downloads
      - alert: SlowDownloads
        expr: |
          histogram_quantile(0.95,
            rate(doradura_download_duration_seconds_bucket[5m])
          ) > 60
        for: 10m
        labels:
          severity: warning
          component: performance
        annotations:
          summary: "Downloads are slow"
          description: "95th percentile download time is {{ $value | humanize }}s (threshold: 60s)"

      # Low success rate
      - alert: LowSuccessRate
        expr: |
          (
            sum(rate(doradura_download_success_total[10m]))
            /
            sum(rate(doradura_download_success_total[10m]) + rate(doradura_download_failure_total[10m]))
          ) * 100 < 90
        for: 10m
        labels:
          severity: warning
          component: downloads
        annotations:
          summary: "Download success rate is low"
          description: "Success rate is {{ $value | humanize }}% (threshold: 90%)"

      # High retry rate
      - alert: HighRetryRate
        expr: |
          sum(rate(doradura_errors_total{category="retry"}[5m])) > 1
        for: 5m
        labels:
          severity: warning
          component: reliability
        annotations:
          summary: "High retry rate detected"
          description: "Retry rate: {{ $value | humanize }} retries/sec"

      # Drop in active users
      - alert: LowDailyActiveUsers
        expr: |
          doradura_daily_active_users < 10 and hour() > 8 and hour() < 22
        for: 30m
        labels:
          severity: warning
          component: engagement
        annotations:
          summary: "Low daily active users"
          description: "Only {{ $value }} active users today"

      # ========================================
      # BUSINESS METRICS ALERTS
      # ========================================

      # Payment failures
      - alert: PaymentFailures
        expr: |
          sum(rate(doradura_errors_total{category="payment"}[5m])) > 0
        for: 1m
        labels:
          severity: critical
          component: payments
        annotations:
          summary: "Payment failures detected"
          description: "{{ $value | humanize }} payment errors/sec"

      # Low conversion
      - alert: LowConversionRate
        expr: |
          (
            sum(rate(doradura_new_subscriptions_total[1h]))
            /
            sum(rate(doradura_command_usage_total{command="start"}[1h]))
          ) * 100 < 1
        for: 2h
        labels:
          severity: warning
          component: business
        annotations:
          summary: "Low conversion rate"
          description: "Conversion rate is {{ $value | humanize }}% (threshold: 1%)"

      # High subscription cancellation rate
      - alert: HighCancellationRate
        expr: |
          sum(rate(doradura_subscription_cancellations_total[1h])) > 5
        for: 1h
        labels:
          severity: warning
          component: business
        annotations:
          summary: "High subscription cancellation rate"
          description: "{{ $value | humanize }} cancellations per hour"

  # ========================================
  # RECORDING RULES (for query performance)
  # ========================================
  - name: doradura_recording_rules
    interval: 30s
    rules:
      # Success rate over last 5 minutes
      - record: doradura:download_success_rate:5m
        expr: |
          sum(rate(doradura_download_success_total[5m]))
          /
          sum(rate(doradura_download_success_total[5m]) + rate(doradura_download_failure_total[5m]))

      # Error rate over last 5 minutes
      - record: doradura:error_rate:5m
        expr: |
          sum(rate(doradura_download_failure_total[5m]))
          /
          sum(rate(doradura_download_success_total[5m]) + rate(doradura_download_failure_total[5m]))

      # Average download duration
      - record: doradura:download_duration:avg:5m
        expr: |
          histogram_quantile(0.5,
            rate(doradura_download_duration_seconds_bucket[5m])
          )

      # 95th percentile download duration
      - record: doradura:download_duration:p95:5m
        expr: |
          histogram_quantile(0.95,
            rate(doradura_download_duration_seconds_bucket[5m])
          )

      # Total downloads per second
      - record: doradura:downloads:rate:5m
        expr: |
          sum(rate(doradura_download_success_total[5m]) + rate(doradura_download_failure_total[5m]))
