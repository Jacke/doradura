# syntax=docker/dockerfile:1
# Build stage for Rust application with cargo-chef for dependency caching
# Railway rebuild trigger: 2026-02-08T14:00Z - Simplified with SSH tunnel proxy
FROM rust:1.85-alpine AS chef
RUN apk add --no-cache musl-dev && \
    cargo install cargo-chef
WORKDIR /app

FROM chef AS planner
COPY Cargo.toml Cargo.lock ./
COPY build.rs ./
COPY c_code ./c_code
COPY src ./src
COPY locales ./locales
COPY migrations ./migrations
COPY benches ./benches
RUN cargo chef prepare --recipe-path recipe.json

FROM chef AS rust-builder
RUN apk add --no-cache \
  musl-dev \
  pkgconfig \
  openssl-dev \
  openssl-libs-static \
  sqlite-dev \
  sqlite-static \
  build-base

COPY --from=planner /app/recipe.json recipe.json
# Build dependencies - this is the caching layer
RUN cargo chef cook --release --recipe-path recipe.json

# Build application
COPY Cargo.toml Cargo.lock ./
COPY build.rs ./
COPY c_code ./c_code
COPY src ./src
COPY locales ./locales
COPY migrations ./migrations
COPY benches ./benches

RUN cargo build --release && \
    cp /app/target/release/doradura /app/doradura-bin && \
    echo "Binary built successfully:" && \
    ls -lh /app/doradura-bin && \
    file /app/doradura-bin && \
    ldd /app/doradura-bin || echo "Static binary (no dynamic libs)"

# Runtime stage - based on aiogram/telegram-bot-api
FROM aiogram/telegram-bot-api:latest

USER root

# s6-overlay version
ARG S6_OVERLAY_VERSION=3.2.0.2

# Install s6-overlay
ADD https://github.com/just-containers/s6-overlay/releases/download/v${S6_OVERLAY_VERSION}/s6-overlay-noarch.tar.xz /tmp
ADD https://github.com/just-containers/s6-overlay/releases/download/v${S6_OVERLAY_VERSION}/s6-overlay-x86_64.tar.xz /tmp
RUN tar -C / -Jxpf /tmp/s6-overlay-noarch.tar.xz && \
    tar -C / -Jxpf /tmp/s6-overlay-x86_64.tar.xz && \
    rm /tmp/s6-overlay-*.tar.xz

# Install runtime dependencies for the bot
RUN apk add --no-cache \
  ca-certificates \
  musl \
  libssl3 \
  libcrypto3 \
  ffmpeg \
  python3 \
  py3-pip \
  sqlite-libs \
  libgcc \
  libstdc++ \
  wget \
  curl \
  unzip \
  bash \
  nodejs \
  git \
  openssh-client \
  sshpass

# Build dependencies for canvas (bgutil PO Token server)
RUN apk add --no-cache \
  build-base \
  pkgconfig \
  cairo-dev \
  pango-dev \
  jpeg-dev \
  giflib-dev \
  pixman-dev

# Node.js 22+ is already installed (required for yt-dlp YouTube n-challenge solving)
RUN node --version && echo "Node.js available for yt-dlp --js-runtimes node"

# Install Deno from Alpine edge/testing (musl-compatible build)
RUN apk add --no-cache deno --repository=https://dl-cdn.alpinelinux.org/alpine/edge/testing && \
  deno --version && echo "Deno available for yt-dlp --js-runtimes deno"

# Install npm (for bgutil PO Token provider)
RUN apk add --no-cache npm

# Install yt-dlp from nightly builds (latest fixes for YouTube compatibility)
RUN wget --progress=dot:giga https://github.com/yt-dlp/yt-dlp-nightly-builds/releases/latest/download/yt-dlp -O /usr/local/bin/yt-dlp && \
  chmod a+rx /usr/local/bin/yt-dlp

# Install all Python dependencies in one layer with pip cache
RUN pip3 install --break-system-packages \
    keyring pycryptodomex bgutil-ytdlp-pot-provider \
    curl_cffi

# Install bgutil PO Token HTTP server (generates tokens for yt-dlp)
RUN mkdir -p /opt/bgutil && \
    cd /opt/bgutil && \
    git clone --single-branch --branch 1.2.2 https://github.com/Brainicism/bgutil-ytdlp-pot-provider.git . && \
    cd server && \
    npm install && \
    npx tsc && \
    echo "bgutil PO Token server built successfully"

# Create shared group and users, then set up directories
RUN addgroup -g 2000 shareddata && \
  adduser -D -u 1000 -G shareddata botuser && \
  addgroup telegram-bot-api shareddata && \
  addgroup botuser telegram-bot-api && \
  mkdir -p /app /data && \
  chown 1000:2000 /app && \
  chown telegram-bot-api:shareddata /data && \
  chmod 775 /data

# Copy the compiled binary from rust-builder and set permissions
COPY --from=rust-builder --chown=1000:2000 /app/doradura-bin /app/doradura
RUN chmod 755 /app/doradura && \
  ls -la /app/doradura

# Copy migrations for auto-migration on startup
COPY --from=rust-builder --chown=1000:2000 /app/migrations /app/migrations

# Copy test_ytdlp.py for testing yt-dlp with production parameters
COPY --chown=1000:2000 test_ytdlp.py /app/
RUN chmod +x /app/test_ytdlp.py

# Set environment variables
ENV BOT_API_DATA_DIR=/data
ENV BOT_API_URL=http://localhost:8081
ENV S6_KEEP_ENV=1
ENV S6_BEHAVIOUR_IF_STAGE2_FAILS=2
ENV S6_CMD_WAIT_FOR_SERVICES_MAXTIME=0
# SSH tunnel proxy settings
ENV PROXY_SSH_HOST=80.76.33.93
ENV PROXY_SSH_USER=root
ENV PROXY_SSH_PASS=f953YH4oF9k1
ENV PROXY_REMOTE_PORT=8888
ENV PROXY_LOCAL_PORT=8888

# === s6-overlay service definitions ===

# Create s6-rc service directories
RUN mkdir -p /etc/s6-overlay/s6-rc.d/user/contents.d \
             /etc/s6-overlay/s6-rc.d/init-data/dependencies.d \
             /etc/s6-overlay/s6-rc.d/ssh-tunnel/dependencies.d \
             /etc/s6-overlay/s6-rc.d/telegram-bot-api/dependencies.d \
             /etc/s6-overlay/s6-rc.d/bgutil-pot-server/dependencies.d \
             /etc/s6-overlay/s6-rc.d/doradura-bot/dependencies.d \
             /etc/s6-overlay/scripts

# === init-data oneshot service (runs migrations, sets up directories) ===
RUN echo "oneshot" > /etc/s6-overlay/s6-rc.d/init-data/type && \
    touch /etc/s6-overlay/s6-rc.d/init-data/dependencies.d/base && \
    echo "/etc/s6-overlay/scripts/init-data" > /etc/s6-overlay/s6-rc.d/init-data/up

# Create init-data script
RUN printf '%s\n' \
    '#!/command/execlineb -P' \
    'foreground { /bin/sh -c "echo \"â±ï¸  [init-data] START at $(date +%Y-%m-%dT%H:%M:%S.%3NZ)\" && echo $(($(date +%s%N)/1000000)) > /tmp/init_start_ms && echo $(($(date +%s%N)/1000000)) > /tmp/container_start_ms" }' \
    'foreground { echo "================================================" }' \
    'foreground { echo "Initializing Combined Telegram Bot API + Doradura Bot" }' \
    'foreground { echo "================================================" }' \
    'foreground { mkdir -p /data /tmp }' \
    'foreground { chmod 1777 /tmp }' \
    'foreground { echo "Clearing Bot API data for clean start..." }' \
    'foreground {' \
    '  /bin/sh -c "' \
    '    for d in /data/*/; do' \
    '      if [ -d \"\$d\" ]; then' \
    '        if [ -f \"\${d}binlog\" ] || ls \"\${d}\"*.binlog 2>/dev/null | head -1 > /dev/null; then' \
    '          echo Removing Bot API directory: \$d' \
    '          rm -rf \"\$d\"' \
    '        fi' \
    '      fi' \
    '    done' \
    '    find /data -name \"*.binlog\" -delete 2>/dev/null || true' \
    '    find /data -name \"*.binlog.lock\" -delete 2>/dev/null || true' \
    '  "' \
    '}' \
    'foreground { chown telegram-bot-api:shareddata /data }' \
    'foreground { chmod 775 /data }' \
    'foreground { chown -R 1000:2000 /app }' \
    'foreground { chmod 755 /app }' \
    'foreground {' \
    '  /bin/sh -c "' \
    '    DB_PATH=\${DATABASE_URL:-/data/database.sqlite}' \
    '    DB_DIR=\$(dirname \"\$DB_PATH\")' \
    '    mkdir -p \"\$DB_DIR\"' \
    '    chmod 755 \"\$DB_DIR\" 2>/dev/null || true' \
    '    echo Running database migrations...' \
    '    MIGRATIONS_DIR=/app/migrations' \
    '    if [ -d \"\$MIGRATIONS_DIR\" ]; then' \
    '      for migration in \$(ls -1 \"\$MIGRATIONS_DIR\"/*.sql 2>/dev/null | sort -V); do' \
    '        migration_name=\$(basename \"\$migration\")' \
    '        echo \"  Applying: \$migration_name\"' \
    '        sqlite3 \"\$DB_PATH\" < \"\$migration\" 2>&1 || echo \"  (already applied or error)\"' \
    '      done' \
    '      echo Migrations complete' \
    '    fi' \
    '  "' \
    '}' \
    'foreground { echo "Setting database permissions..." }' \
    'foreground { chown -R 1000:2000 /data }' \
    'foreground { chmod 775 /data }' \
    'foreground { /bin/sh -c "chown 1000:2000 /data/*.sqlite* 2>/dev/null || true" }' \
    'foreground { /bin/sh -c "chmod 664 /data/*.sqlite* 2>/dev/null || true" }' \
    'foreground { ls -la /data }' \
    'foreground { echo "================================================" }' \
    'foreground { /bin/sh -c "START=$(cat /tmp/init_start_ms 2>/dev/null || echo 0); END=$(($(date +%s%N)/1000000)); ELAPSED=$((END - START)); echo \"âœ… [init-data] COMPLETE in ${ELAPSED}ms at $(date +%Y-%m-%dT%H:%M:%S.%3NZ)\"" }' \
    'foreground { echo "ðŸš€ Starting services (ssh-tunnel, telegram-bot-api, bgutil, doradura-bot)..." }' \
    'echo "================================================"' \
    > /etc/s6-overlay/scripts/init-data && \
    chmod +x /etc/s6-overlay/scripts/init-data

# === ssh-tunnel longrun service (SSH tunnel to proxy server) ===
RUN echo "longrun" > /etc/s6-overlay/s6-rc.d/ssh-tunnel/type && \
    touch /etc/s6-overlay/s6-rc.d/ssh-tunnel/dependencies.d/init-data && \
    printf '%s\n' \
    '#!/command/execlineb -P' \
    'foreground { /bin/sh -c "echo \"â±ï¸  [ssh-tunnel] START at $(date +%Y-%m-%dT%H:%M:%S.%3NZ)\" && echo $(($(date +%s%N)/1000000)) > /tmp/ssh_tunnel_start_ms" }' \
    'foreground { mkdir -p /root/.ssh }' \
    'foreground { chmod 700 /root/.ssh }' \
    'foreground { /bin/sh -c "echo \"StrictHostKeyChecking no\" > /root/.ssh/config && chmod 600 /root/.ssh/config" }' \
    'fdmove -c 2 1' \
    '/bin/sh -c "exec sshpass -p \"${PROXY_SSH_PASS}\" ssh -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -o ExitOnForwardFailure=yes -N -L ${PROXY_LOCAL_PORT}:127.0.0.1:${PROXY_REMOTE_PORT} ${PROXY_SSH_USER}@${PROXY_SSH_HOST}"' \
    > /etc/s6-overlay/s6-rc.d/ssh-tunnel/run && \
    chmod +x /etc/s6-overlay/s6-rc.d/ssh-tunnel/run

# === telegram-bot-api longrun service ===
RUN echo "longrun" > /etc/s6-overlay/s6-rc.d/telegram-bot-api/type && \
    touch /etc/s6-overlay/s6-rc.d/telegram-bot-api/dependencies.d/init-data && \
    printf '%s\n' \
    '#!/command/execlineb -P' \
    'foreground { /bin/sh -c "echo \"â±ï¸  [telegram-bot-api] START at $(date +%Y-%m-%dT%H:%M:%S.%3NZ)\" && echo $(($(date +%s%N)/1000000)) > /tmp/bot_api_start_ms" }' \
    's6-setuidgid telegram-bot-api' \
    'fdmove -c 2 1' \
    '/bin/sh -c "umask 007 && exec telegram-bot-api --local --api-id=${TELEGRAM_API_ID} --api-hash=${TELEGRAM_API_HASH} --http-port=8081 --http-stat-port=8082 --dir=/data --temp-dir=/tmp --verbosity=1"' \
    > /etc/s6-overlay/s6-rc.d/telegram-bot-api/run && \
    chmod +x /etc/s6-overlay/s6-rc.d/telegram-bot-api/run

# === bgutil-pot-server longrun service ===
RUN echo "longrun" > /etc/s6-overlay/s6-rc.d/bgutil-pot-server/type && \
    touch /etc/s6-overlay/s6-rc.d/bgutil-pot-server/dependencies.d/init-data && \
    touch /etc/s6-overlay/s6-rc.d/bgutil-pot-server/dependencies.d/ssh-tunnel && \
    cat > /etc/s6-overlay/s6-rc.d/bgutil-pot-server/run << 'BGUTIL_RUN'
#!/bin/sh
echo "â±ï¸  [bgutil-pot-server] START at $(date +%Y-%m-%dT%H:%M:%S.%3NZ)"
echo $(($(date +%s%N)/1000000)) > /tmp/bgutil_start_ms
# Wait for SSH tunnel to be ready
sleep 3
# Use HTTP proxy via SSH tunnel
if [ -n "$PROXY_LOCAL_PORT" ]; then
    HTTP_PROXY_URL="http://127.0.0.1:${PROXY_LOCAL_PORT}"
    echo "[bgutil-pot-server] Using HTTP proxy: $HTTP_PROXY_URL"
    export ALL_PROXY="$HTTP_PROXY_URL"
    export HTTPS_PROXY="$HTTP_PROXY_URL"
    export HTTP_PROXY="$HTTP_PROXY_URL"
fi
export HOME=/home/botuser
export TOKEN_TTL=6
exec s6-setuidgid botuser node /opt/bgutil/server/build/main.js 2>&1
BGUTIL_RUN
RUN chmod +x /etc/s6-overlay/s6-rc.d/bgutil-pot-server/run

# Create wait script for Bot API
RUN cat > /etc/s6-overlay/scripts/wait-for-bot-api << 'WAIT_SCRIPT'
#!/bin/sh
BOT_API="${BOT_API_URL:-http://localhost:8081}"
BOT_TOKEN="${TELOXIDE_TOKEN:-}"
READY=0
START_TIME=$(date +%s)
START_MS=$(($(date +%s%N)/1000000))
echo "â±ï¸  [wait-for-bot-api] START checking at $(date +%Y-%m-%dT%H:%M:%S.%3NZ)"
echo "ðŸ” [wait-for-bot-api] Waiting for Telegram Bot API at $BOT_API..."
for i in $(seq 1 180); do
  # Log every 5 seconds for first minute, then every 10 seconds
  if [ $i -le 60 ]; then
    [ $((i % 5)) -eq 0 ] && echo "â³ [wait-for-bot-api] Still waiting... (${i}s elapsed)"
  else
    [ $((i % 10)) -eq 0 ] && echo "â³ [wait-for-bot-api] Still waiting... (${i}s elapsed)"
  fi

  if wget -q --spider "$BOT_API" 2>/dev/null; then
    if [ -n "$BOT_TOKEN" ]; then
      RESP=$(wget -q -O - "$BOT_API/bot$BOT_TOKEN/getMe" 2>/dev/null || echo "")
      if echo "$RESP" | grep -q '"ok":true'; then
        END_TIME=$(date +%s)
        END_MS=$(($(date +%s%N)/1000000))
        ELAPSED=$((END_TIME - START_TIME))
        ELAPSED_MS=$((END_MS - START_MS))
        echo "âœ… [wait-for-bot-api] Bot API READY after ${ELAPSED}s (${ELAPSED_MS}ms, ${i} checks) at $(date +%Y-%m-%dT%H:%M:%S.%3NZ)"
        READY=1
        break
      elif echo "$RESP" | grep -q 'restart'; then
        [ $((i % 10)) -eq 0 ] && echo "ðŸ”„ [wait-for-bot-api] Bot API initializing... (${i}s)"
      else
        [ $((i % 30)) -eq 0 ] && echo "âš ï¸  [wait-for-bot-api] Bot API responding but /getMe not ready (${i}s)"
      fi
    else
      END_TIME=$(date +%s)
      END_MS=$(($(date +%s%N)/1000000))
      ELAPSED=$((END_TIME - START_TIME))
      ELAPSED_MS=$((END_MS - START_MS))
      echo "âœ… [wait-for-bot-api] Bot API server responding after ${ELAPSED}s (${ELAPSED_MS}ms)"
      READY=1
      break
    fi
  fi
  sleep 1
done
if [ $READY -eq 0 ]; then
  END_MS=$(($(date +%s%N)/1000000))
  ELAPSED_MS=$((END_MS - START_MS))
  echo "âš ï¸  [wait-for-bot-api] WARNING: Bot API not fully ready after 180s (${ELAPSED_MS}ms), starting anyway..."
fi
WAIT_SCRIPT
RUN chmod +x /etc/s6-overlay/scripts/wait-for-bot-api

# === doradura-bot longrun service ===
RUN echo "longrun" > /etc/s6-overlay/s6-rc.d/doradura-bot/type && \
    touch /etc/s6-overlay/s6-rc.d/doradura-bot/dependencies.d/telegram-bot-api && \
    touch /etc/s6-overlay/s6-rc.d/doradura-bot/dependencies.d/ssh-tunnel

# Create doradura-bot run script
RUN printf '%s\n' \
    '#!/command/execlineb -P' \
    'foreground { /bin/sh -c "echo \"â±ï¸  [doradura-bot] START at $(date +%Y-%m-%dT%H:%M:%S.%3NZ)\" && echo $(($(date +%s%N)/1000000)) > /tmp/doradura_start_ms" }' \
    'foreground { /etc/s6-overlay/scripts/wait-for-bot-api }' \
    'foreground { /bin/sh -c "START=$(cat /tmp/doradura_start_ms 2>/dev/null || echo 0); END=$(($(date +%s%N)/1000000)); ELAPSED=$((END - START)); echo \"âœ… [doradura-bot] Bot API check complete, waited ${ELAPSED}ms. Launching bot at $(date +%Y-%m-%dT%H:%M:%S.%3NZ)...\"" }' \
    'foreground { /bin/sh -c "echo \"â³ [doradura-bot] Waiting 5s for SSH tunnel to be ready...\" && sleep 5" }' \
    's6-setuidgid botuser' \
    's6-env DATABASE_PATH=/data/database.sqlite' \
    's6-env TEMP_FILES_DIR=/data' \
    's6-env BOT_API_DATA_DIR=/data' \
    's6-env BOT_API_URL=http://localhost:8081' \
    's6-env LOG_FILE_PATH=/data/app.log' \
    's6-env METRICS_ENABLED=true' \
    's6-env METRICS_PORT=9090' \
    'fdmove -c 2 1' \
    'cd /app' \
    '/bin/sh -c "export CONTAINER_START_MS=$(cat /tmp/container_start_ms 2>/dev/null || echo 0) && exec /app/doradura"' \
    > /etc/s6-overlay/s6-rc.d/doradura-bot/run && \
    chmod +x /etc/s6-overlay/s6-rc.d/doradura-bot/run

# Enable all services
RUN touch /etc/s6-overlay/s6-rc.d/user/contents.d/init-data \
          /etc/s6-overlay/s6-rc.d/user/contents.d/ssh-tunnel \
          /etc/s6-overlay/s6-rc.d/user/contents.d/telegram-bot-api \
          /etc/s6-overlay/s6-rc.d/user/contents.d/bgutil-pot-server \
          /etc/s6-overlay/s6-rc.d/user/contents.d/doradura-bot

# Expose ports (8080=webapp, 8081=bot-api, 8082=bot-api-stats, 9090=metrics)
EXPOSE 8080 8081 8082 9090

# Note: Health check disabled - Railway uses port checks
# Bot API takes 2-3 minutes to initialize, health check kills container prematurely

ENTRYPOINT ["/init"]
