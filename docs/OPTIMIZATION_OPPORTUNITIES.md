# üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **`.clone()` –≤—ã–∑–æ–≤–æ–≤**: 42 (–º–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å –¥–æ ~20)
- **`.to_string()` –≤—ã–∑–æ–≤–æ–≤**: 75 (–º–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å –¥–æ ~50)
- **`env::var()` –≤—ã–∑–æ–≤–æ–≤**: 5 (–º–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å –¥–æ 1 —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
- **–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î**: 2-3 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ (–º–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å)

---

## üî• –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–±—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è, —Ö–æ—Ä–æ—à–∏–π —ç—Ñ—Ñ–µ–∫—Ç)

### 1. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ `YTDL_BIN` –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è ‚ö°

**–ü—Ä–æ–±–ª–µ–º–∞**: `env::var("YTDL_BIN")` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è 5 —Ä–∞–∑ –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö

**–¢–µ–∫—É—â–∏–π –∫–æ–¥**:
```rust
// –í downloader.rs (5 –º–µ—Å—Ç)
let ytdl_bin = env::var("YTDL_BIN").ok().unwrap_or_else(|| "yt-dlp".to_string());
```

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Lazy` –¥–ª—è –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

**–§–∞–π–ª**: `src/config.rs` –∏–ª–∏ `src/downloader.rs`

```rust
use once_cell::sync::Lazy;

static YTDL_BIN: Lazy<String> = Lazy::new(|| {
    env::var("YTDL_BIN").unwrap_or_else(|_| "yt-dlp".to_string())
});

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
let ytdl_bin = &*YTDL_BIN; // –ù–µ –∫–ª–æ–Ω–∏—Ä—É–µ—Ç—Å—è, —Ç–æ–ª—å–∫–æ —Å—Å—ã–ª–∫–∞
```

**–≠—Ñ—Ñ–µ–∫—Ç**: 
- –£–±–∏—Ä–∞–µ—Ç 4 –ª–∏—à–Ω–∏—Ö –≤—ã–∑–æ–≤–∞ `env::var()`
- –£–±–∏—Ä–∞–µ—Ç 4 –ª–∏—à–Ω–∏—Ö `.to_string()` –≤—ã–¥–µ–ª–µ–Ω–∏–π –ø–∞–º—è—Ç–∏
- **–í—Ä–µ–º—è**: 10 –º–∏–Ω—É—Ç

---

### 2. –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è `display_title` üìù

**–ü—Ä–æ–±–ª–µ–º–∞**: `display_title.clone()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è 4-5 —Ä–∞–∑ –≤ –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** (`downloader.rs:328-336, 348, 638-646`):
```rust
let display_title = if artist.trim().is_empty() {
    title.clone()
} else {
    format!("{} - {}", artist, title)
};

// –ü–æ—Ç–æ–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–Ω–æ–≥–æ —Ä–∞–∑:
progress_msg.update(&bot_clone, DownloadStatus::Starting {
    title: display_title.clone()  // ‚ùå –ö–ª–æ–Ω 1
}).await;

let title_for_progress = display_title.clone();  // ‚ùå –ö–ª–æ–Ω 2
// ... –µ—â–µ 2-3 –∫–ª–æ–Ω–∞
```

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Arc<str>` –∏–ª–∏ `Cow<str>`

```rust
use std::borrow::Cow;

let display_title: Cow<str> = if artist.trim().is_empty() {
    Cow::Borrowed(&title)
} else {
    Cow::Owned(format!("{} - {}", artist, title))
};

// –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Arc<str> –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏:
let display_title = Arc::new(display_title.into_owned());
let display_title_clone = Arc::clone(&display_title); // –î–µ—à–µ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
```

**–≠—Ñ—Ñ–µ–∫—Ç**:
- –£–±–∏—Ä–∞–µ—Ç 3-4 –ª–∏—à–Ω–∏—Ö –∫–ª–æ–Ω–∞ —Å—Ç—Ä–æ–∫–∏ (~50-200 –±–∞–π—Ç –∫–∞–∂–¥—ã–π)
- –£—Å–∫–æ—Ä—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
- **–í—Ä–µ–º—è**: 15 –º–∏–Ω—É—Ç

---

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL üîó

**–ü—Ä–æ–±–ª–µ–º–∞**: –°–æ–∑–¥–∞–µ—Ç—Å—è `Vec<(String, String)>` –¥–∞–∂–µ –∫–æ–≥–¥–∞ —ç—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** (`commands.rs:99-110`):
```rust
if url.query_pairs().any(|(key, _)| key == "list") {
    let preserved_params: Vec<(String, String)> = url.query_pairs()
        .filter(|(key, _)| key != "list")
        .map(|(key, value)| (key.to_string(), value.to_string()))  // ‚ùå –õ–∏—à–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è
        .collect();
    
    url.query_pairs_mut().clear();
    
    for (key, value) in preserved_params {
        url.query_pairs_mut().append_pair(&key, &value);
    }
}
```

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Url::set_query` –Ω–∞–ø—Ä—è–º—É—é

```rust
if url.query_pairs().any(|(key, _)| key == "list") {
    let mut pairs: Vec<(&str, &str)> = url.query_pairs()
        .filter(|(key, _)| key != "list")
        .map(|(k, v)| (k.as_ref(), v.as_ref()))
        .collect();
    
    // –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å query –±–µ–∑ "list"
    let new_query = if pairs.is_empty() {
        None
    } else {
        Some(pairs.iter()
            .map(|(k, v)| format!("{}={}", k, v))
            .collect::<Vec<_>>()
            .join("&"))
    };
    url.set_query(new_query.as_deref());
}
```

**–ò–ª–∏ –µ—â–µ –ª—É—á—à–µ** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π –º–µ—Ç–æ–¥ `url::Url`:
```rust
// –ë–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - —Ä–∞–±–æ—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é —Å query
let mut new_query = String::new();
for (key, value) in url.query_pairs() {
    if key != "list" {
        if !new_query.is_empty() {
            new_query.push('&');
        }
        new_query.push_str(&key);
        new_query.push('=');
        new_query.push_str(&value);
    }
}
url.set_query(if new_query.is_empty() { None } else { Some(&new_query) });
```

**–≠—Ñ—Ñ–µ–∫—Ç**:
- –£–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –¥–ª—è Vec –∏ String
- –£—Å–∫–æ—Ä—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É URL –Ω–∞ ~20-30%
- **–í—Ä–µ–º—è**: 20 –º–∏–Ω—É—Ç

---

### 4. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î üìä

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** (`main.rs:190-216`):
```rust
// –í handle_message:
let format = match db::get_connection(&db_pool) {
    Ok(conn) => {
        db::get_user_download_format(&conn, msg.chat.id.0)  // ‚ùå –ó–∞–ø—Ä–æ—Å 1
            .unwrap_or_else(|_| "mp3".to_string())
    }
    // ...
}

// –ü–æ—Ç–æ–º –≤ main.rs –µ—â–µ —Ä–∞–∑:
match get_connection(&db_pool) {
    Ok(conn) => {
        match get_user(&conn, chat_id) {  // ‚ùå –ó–∞–ø—Ä–æ—Å 2 (–ø–æ–ª—É—á–∞–µ—Ç –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å–Ω–æ–≤–∞)
            // ...
        }
    }
}
```

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `get_user()` –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –ø–æ–ª—É—á–∞–µ—Ç `download_format`

```rust
// –í handle_message –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å Option<User> –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç
let user_info = match db::get_connection(&db_pool) {
    Ok(conn) => db::get_user(&conn, msg.chat.id.0).ok().flatten(),
    Err(_) => None,
};

let format = user_info
    .as_ref()
    .map(|u| u.download_format.clone())
    .unwrap_or_else(|| "mp3".to_string());

// –ü–µ—Ä–µ–¥–∞—Ç—å user_info –¥–∞–ª—å—à–µ –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
```

**–≠—Ñ—Ñ–µ–∫—Ç**:
- –£–±–∏—Ä–∞–µ—Ç –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫ –ë–î –Ω–∞ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –£—Å–∫–æ—Ä—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–∞ ~5-10ms
- **–í—Ä–µ–º—è**: 30 –º–∏–Ω—É—Ç

---

## ‚ö° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—Ö–æ—Ä–æ—à–∏–π —ç—Ñ—Ñ–µ–∫—Ç, –±–æ–ª—å—à–µ —Ä–∞–±–æ—Ç—ã)

### 5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `&str` –≤–º–µ—Å—Ç–æ `String` –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ üî§

**–ü—Ä–æ–±–ª–µ–º–∞**: –ú–Ω–æ–≥–æ `.to_string()` –≥–¥–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `&str`

**–ü—Ä–∏–º–µ—Ä—ã**:
- `commands.rs:85` - `format!()` —Å–æ–∑–¥–∞–µ—Ç String, –Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Cow<str>`
- `downloader.rs:319, 629, 787` - `e.to_string().contains()` –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `e.to_string()` —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Cow<str>` –¥–ª—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

```rust
// –í–º–µ—Å—Ç–æ:
let format = "mp3".to_string();  // ‚ùå

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
let format: &str = "mp3";  // ‚úÖ
// –ò–ª–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–ª–∞–¥–µ–Ω–∏–µ:
let format = String::from("mp3");  // ‚úÖ (—á—É—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ —á–µ–º to_string())
```

**–≠—Ñ—Ñ–µ–∫—Ç**:
- –£–±–∏—Ä–∞–µ—Ç ~10-15 –ª–∏—à–Ω–∏—Ö –≤—ã–¥–µ–ª–µ–Ω–∏–π –ø–∞–º—è—Ç–∏
- **–í—Ä–µ–º—è**: 1 —á–∞—Å

---

### 6. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫ –≤ `progress.rs` üìù

**–ü—Ä–æ–±–ª–µ–º–∞**: –ú–Ω–æ–≥–æ `format!()` –≤—ã–∑–æ–≤–æ–≤ —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** (`progress.rs:74-115`):
```rust
format!("üéµ *{}*\n\n‚è≥ –ù–∞—á–∏–Ω–∞—é —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ\\.\\.\\.", escape_markdown(title))
```

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `String::with_capacity()` –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏

```rust
pub fn to_message(&self) -> String {
    match self {
        DownloadStatus::Starting { title } => {
            let escaped = escape_markdown(title);
            let mut s = String::with_capacity(escaped.len() + 50);
            s.push_str("üéµ *");
            s.push_str(&escaped);
            s.push_str("*\n\n‚è≥ –ù–∞—á–∏–Ω–∞—é —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ\\.\\.\\.");
            s
        }
        // ...
    }
}
```

**–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Cow<str>` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ª–∏—à–Ω–∏—Ö –∫–æ–ø–∏–π**:
```rust
use std::borrow::Cow;

fn escape_markdown_cow(s: &str) -> Cow<str> {
    if s.chars().any(|c| matches!(c, '_' | '*' | '[' | ']' | '(' | ')' | '~' | '`' | '>' | '#' | '+' | '-' | '=' | '|' | '{' | '}' | '.' | '!')) {
        Cow::Owned(escape_markdown(s))
    } else {
        Cow::Borrowed(s)
    }
}
```

**–≠—Ñ—Ñ–µ–∫—Ç**:
- –£–º–µ–Ω—å—à–∞–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –Ω–∞ ~30%
- –£—Å–∫–æ—Ä—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ ~10-15%
- **–í—Ä–µ–º—è**: 1 —á–∞—Å

---

### 7. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è `Bot` ü§ñ

**–ü—Ä–æ–±–ª–µ–º–∞**: `bot.clone()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑, —Ö–æ—Ç—è `Bot` —É–∂–µ `Arc` –≤–Ω—É—Ç—Ä–∏

**–¢–µ–∫—É—â–∏–π –∫–æ–¥**:
```rust
let bot_clone = bot.clone();  // –î–µ—à–µ–≤–æ, –Ω–æ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å
let bot_for_progress = bot_clone.clone();
```

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Arc::clone()` —è–≤–Ω–æ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å—Å—ã–ª–∫–∏

```rust
// Bot —É–∂–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Arc, –Ω–æ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å:
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å &Bot –≤–µ–∑–¥–µ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ –≤–º–µ—Å—Ç–æ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –≠—Ç–æ –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, —Ç–∞–∫ –∫–∞–∫ `Bot::clone()` —É–∂–µ –¥–µ—à–µ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (Arc)

**–≠—Ñ—Ñ–µ–∫—Ç**: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π, –Ω–æ —É–ª—É—á—à–∞–µ—Ç —á–∏—Ç–∞–µ–º–æ—Å—Ç—å
**–í—Ä–µ–º—è**: 30 –º–∏–Ω—É—Ç

---

## üéØ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –∏–ª–∏ —Å–ª–æ–∂–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)

### 8. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `Arc<str>` –≤–º–µ—Å—Ç–æ `String` –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ö üì¶

**–ü—Ä–æ–±–ª–µ–º–∞**: `DownloadTask` —Å–æ–¥–µ—Ä–∂–∏—Ç `String` –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –∫–ª–æ–Ω–∏—Ä—É—é—Ç—Å—è

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** (`queue.rs:12-25`):
```rust
pub struct DownloadTask {
    pub id: String,
    pub url: String,
    pub format: String,
    // ...
}
```

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Arc<str>` –¥–ª—è –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã—Ö —Å—Ç—Ä–æ–∫

```rust
pub struct DownloadTask {
    pub id: Arc<str>,
    pub url: Arc<str>,
    pub format: Arc<str>,
    // ...
}
```

**–≠—Ñ—Ñ–µ–∫—Ç**: 
- –£–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏
- –ù–æ —É—Å–ª–æ–∂–Ω—è–µ—Ç –∫–æ–¥
- **–í—Ä–µ–º—è**: 2 —á–∞—Å–∞ + —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥

---

### 9. –ë–∞—Ç—á–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î üìä

**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

```rust
// –í–º–µ—Å—Ç–æ:
create_user(&conn, telegram_id, username)?;
log_request(&conn, telegram_id, text)?;

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
let tx = conn.transaction()?;
create_user_in_tx(&tx, telegram_id, username)?;
log_request_in_tx(&tx, telegram_id, text)?;
tx.commit()?;
```

**–≠—Ñ—Ñ–µ–∫—Ç**: 
- –£—Å–∫–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ ~20-30% –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
- **–í—Ä–µ–º—è**: 2 —á–∞—Å–∞

---

### 10. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ üéµ

**–ü—Ä–æ–±–ª–µ–º–∞**: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑, –¥–∞–∂–µ –¥–ª—è —Ç–µ—Ö –∂–µ URL

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LRU –∫—ç—à –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

```rust
use lru::LruCache;

static METADATA_CACHE: Lazy<Mutex<LruCache<String, (String, String)>>> = 
    Lazy::new(|| Mutex::new(LruCache::new(100)));

async fn get_metadata_cached(url: &Url) -> Result<(String, String), AppError> {
    let url_str = url.as_str();
    {
        let mut cache = METADATA_CACHE.lock().await;
        if let Some(meta) = cache.get(url_str) {
            return Ok(meta.clone());
        }
    }
    
    let meta = get_metadata_from_ytdlp(url).await?;
    {
        let mut cache = METADATA_CACHE.lock().await;
        cache.put(url_str.to_string(), meta.clone());
    }
    Ok(meta)
}
```

**–≠—Ñ—Ñ–µ–∫—Ç**:
- –£—Å–∫–æ—Ä—è–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ç–µ—Ö –∂–µ URL –Ω–∞ ~90%
- –ù–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (`lru`)
- **–í—Ä–µ–º—è**: 1 —á–∞—Å + –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–π –æ–±—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç

### –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:
- **–£–º–µ–Ω—å—à–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏–π –ø–∞–º—è—Ç–∏**: ~30-40%
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ URL**: ~20-30%
- **–£–º–µ–Ω—å—à–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î**: ~50% (—Å 2 –¥–æ 1 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)
- **–û–±—â–µ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ**: ~10-15%

### –ü–æ—Å–ª–µ –≤—Å–µ—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:
- **–£–º–µ–Ω—å—à–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏–π –ø–∞–º—è—Ç–∏**: ~50-60%
- **–û–±—â–µ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ**: ~20-25%

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. ‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ YTDL_BIN** (10 –º–∏–Ω) - –±—ã—Å—Ç—Ä–∞—è –ø–æ–±–µ–¥–∞
2. ‚úÖ **–£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è display_title** (15 –º–∏–Ω) - —Ö–æ—Ä–æ—à–∏–π —ç—Ñ—Ñ–µ–∫—Ç
3. ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤** (20 –º–∏–Ω) - —É–ª—É—á—à–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É URL
4. ‚úÖ **–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î** (30 –º–∏–Ω) - —É–º–µ–Ω—å—à–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î
5. ‚ö†Ô∏è **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫** (1 —á–∞—Å) - —Å—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
6. ‚ö†Ô∏è **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ &str –≤–º–µ—Å—Ç–æ String** (1 —á–∞—Å) - —Å—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

**–û–±—â–µ–µ –≤—Ä–µ–º—è –¥–ª—è –≤—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö**: ~1.5 —á–∞—Å–∞
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: ~15% —É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–¥–µ–∏

### 11. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ üöÄ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `tokio::select!` –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è stdout/stderr
- **–≠—Ñ—Ñ–µ–∫—Ç**: –£—Å–∫–æ—Ä—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–∞ ~30%

### 12. –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤ üìù
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å async logger —Å –±—É—Ñ–µ—Ä–æ–º
- **–≠—Ñ—Ñ–µ–∫—Ç**: –£–º–µ–Ω—å—à–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏

### 13. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –¥–ª—è –≤–µ–∫—Ç–æ—Ä–æ–≤ üì¶
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Vec::with_capacity()` –≥–¥–µ –∏–∑–≤–µ—Å—Ç–µ–Ω —Ä–∞–∑–º–µ—Ä
- **–≠—Ñ—Ñ–µ–∫—Ç**: –£–º–µ–Ω—å—à–∞–µ—Ç –ø–µ—Ä–µ–∞–ª–ª–æ–∫–∞—Ü–∏–∏

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏–∑–º–µ—Ä–∏—Ç—å –¥–æ –∏ –ø–æ—Å–ª–µ:
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–¥–µ–ª–µ–Ω–∏–π –ø–∞–º—è—Ç–∏ (—á–µ—Ä–µ–∑ `valgrind` –∏–ª–∏ `heaptrack`)
- –†–∞–∑–º–µ—Ä RSS –ø–∞–º—è—Ç–∏
- CPU usage –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ

