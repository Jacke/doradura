# E2E –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –†–µ–∞–ª—å–Ω–æ–≥–æ Telegram

## üéØ –¶–µ–ª—å

–°–æ–∑–¥–∞—Ç—å **–ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ E2E —Ç–µ—Å—Ç—ã** –∫–æ—Ç–æ—Ä—ã–µ:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è—é—Ç –í–°–Æ –ª–æ–≥–∏–∫—É –±–æ—Ç–∞ –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞
- ‚úÖ –ù–µ –¥–µ–ª–∞—é—Ç –ù–ò–ö–ê–ö–ò–• —Ä–µ–∞–ª—å–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –¢–µ—Å—Ç–∏—Ä—É—é—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ë–î, –∫—ç—à, –æ—á–µ—Ä–µ–¥–∏)
- ‚úÖ –ó–∞–ø—É—Å–∫–∞—é—Ç—Å—è –±—ã—Å—Ç—Ä–æ –∏ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –í–∞—à –∫–æ–¥ –±–æ—Ç–∞                          ‚îÇ
‚îÇ  (handlers, commands, download logic)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Bot Abstraction Layer                       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ  ‚îÇ Production Bot   ‚îÇ    ‚îÇ   Test Bot       ‚îÇ          ‚îÇ
‚îÇ  ‚îÇ (real Telegram)  ‚îÇ    ‚îÇ  (mock server)   ‚îÇ          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß –†–µ—à–µ–Ω–∏–µ 1: Trait-based Abstraction (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å trait –¥–ª—è Bot –æ–ø–µ—Ä–∞—Ü–∏–π

```rust
// src/bot_trait.rs

#[async_trait]
pub trait BotOperations: Clone + Send + Sync + 'static {
    async fn send_message(&self, chat_id: ChatId, text: String) -> Result<Message>;
    async fn send_photo(&self, chat_id: ChatId, photo: InputFile) -> Result<Message>;
    async fn send_audio(&self, chat_id: ChatId, audio: InputFile) -> Result<Message>;
    async fn edit_message_text(&self, chat_id: ChatId, message_id: MessageId, text: String) -> Result<()>;
    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
}

// –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞
#[async_trait]
impl BotOperations for Bot {
    async fn send_message(&self, chat_id: ChatId, text: String) -> Result<Message> {
        self.send_message(chat_id, text).await.map_err(|e| e.into())
    }
    // ...
}

// –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–∫–∞
pub struct MockBot {
    mock_server: Arc<TelegramMock>,
    bot: Bot,
}

#[async_trait]
impl BotOperations for MockBot {
    async fn send_message(&self, chat_id: ChatId, text: String) -> Result<Message> {
        self.bot.send_message(chat_id, text).await.map_err(|e| e.into())
    }
    // ...
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** teloxide::Bot –Ω–µ —Ä–µ–∞–ª–∏–∑—É–µ—Ç Clone, –º–µ—Ç–æ–¥—ã —Å–ª–æ–∂–Ω—ã–µ –¥–ª—è –æ–±—ë—Ä—Ç—ã–≤–∞–Ω–∏—è.

## üîß –†–µ—à–µ–Ω–∏–µ 2: Wrapper Pattern (–ü—Ä–æ—â–µ)

### –°–æ–∑–¥–∞—Ç—å –æ–±—ë—Ä—Ç–∫—É –≤–æ–∫—Ä—É–≥ Bot

```rust
// src/testing/test_bot.rs

pub struct TestableBot {
    inner: Bot,
    recorder: Option<Arc<Mutex<Vec<ApiCall>>>>,
}

impl TestableBot {
    // Production
    pub fn production(bot: Bot) -> Self {
        Self { inner: bot, recorder: None }
    }

    // Testing
    pub fn with_mock(mock: TelegramMock) -> Self {
        let bot = mock.create_bot().unwrap();
        Self { inner: bot, recorder: Some(Arc::new(Mutex::new(Vec::new()))) }
    }

    // Wrapper methods
    pub async fn send_message(&self, chat_id: ChatId, text: impl Into<String>) -> ResponseResult<Message> {
        let text = text.into();

        // Record call if in test mode
        if let Some(recorder) = &self.recorder {
            recorder.lock().unwrap().push(ApiCall {
                method: "POST".to_string(),
                path: "/sendMessage".to_string(),
                body: serde_json::json!({"chat_id": chat_id, "text": text}),
                timestamp: 0,
            });
        }

        self.inner.send_message(chat_id, text).await
    }

    // Verification for tests
    pub fn verify_calls(&self, expected: &[(&str, &str)]) {
        if let Some(recorder) = &self.recorder {
            let calls = recorder.lock().unwrap();
            assert_eq!(calls.len(), expected.len());
            // ... verify each call
        }
    }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù—É–∂–Ω–æ –æ–±–µ—Ä–Ω—É—Ç—å –í–°–ï –º–µ—Ç–æ–¥—ã Bot (100+ –º–µ—Ç–æ–¥–æ–≤).

## üîß –†–µ—à–µ–Ω–∏–µ 3: Test Fixtures (–ü—Ä–∞–∫—Ç–∏—á–Ω–æ)

### –ü–æ–ª–Ω–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è —Å—Ä–µ–¥–∞

–í–º–µ—Å—Ç–æ –æ–±–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è Bot, —Å–æ–∑–¥–∞–¥–∏–º **—Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã** –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç –≤—Å—ë –æ–∫—Ä—É–∂–µ–Ω–∏–µ:

```rust
// tests/common/fixtures.rs

pub struct TestEnvironment {
    pub bot: Bot,
    pub db_pool: Arc<DbPool>,
    pub download_queue: Arc<DownloadQueue>,
    pub rate_limiter: Arc<RateLimiter>,
    pub mock: TelegramMock,
}

impl TestEnvironment {
    pub async fn new(snapshot_name: &str) -> anyhow::Result<Self> {
        // 1. Setup mock Telegram API
        let mock = TelegramMock::from_snapshot(snapshot_name).await?;
        let bot = mock.create_bot()?;

        // 2. Setup in-memory database
        let db_pool = Arc::new(create_pool(":memory:")?);
        run_migrations(&db_pool)?;
        insert_test_data(&db_pool)?;

        // 3. Setup download queue
        let download_queue = Arc::new(DownloadQueue::new());

        // 4. Setup rate limiter (disabled for tests)
        let rate_limiter = Arc::new(RateLimiter::new_disabled());

        Ok(Self {
            bot,
            db_pool,
            download_queue,
            rate_limiter,
            mock,
        })
    }

    // Helper: Create test user
    pub fn create_user(&self, user_id: i64) -> anyhow::Result<()> {
        db::create_or_get_user(&self.db_pool, user_id, "ru")?;
        Ok(())
    }

    // Helper: Simulate message from user
    pub fn user_message(&self, user_id: i64, text: &str) -> Message {
        // Deserialize from JSON snapshot or create minimal Message
        self.create_message_from_json(user_id, text)
    }

    // Verify API calls match snapshot
    pub async fn verify(&self) -> anyhow::Result<()> {
        self.mock.verify().await
    }
}
```

## üìù –ü—Ä–∏–º–µ—Ä E2E —Ç–µ—Å—Ç–∞

### Test: –ü–æ–ª–Ω—ã–π flow –∫–æ–º–∞–Ω–¥—ã /start

```rust
// tests/e2e/test_start_command.rs

#[tokio::test]
async fn test_start_command_complete_flow() {
    // 1. Setup environment
    let env = TestEnvironment::new("start_command").await.unwrap();
    env.create_user(123456789).unwrap();

    // 2. Create test message
    let message = env.user_message(123456789, "/start");

    // 3. Call REAL handler
    let result = handle_start_command(
        env.bot.clone(),
        message,
        env.db_pool.clone()
    ).await;

    // 4. Verify handler succeeded
    assert!(result.is_ok());

    // 5. Verify API calls were made
    env.verify().await.unwrap();

    // 6. Verify database state
    let user = db::get_user(&env.db_pool, 123456789).unwrap();
    assert!(user.is_some());
    assert_eq!(user.unwrap().language, "ru");
}
```

### Test: YouTube URL processing E2E

```rust
#[tokio::test]
async fn test_youtube_download_e2e() {
    let env = TestEnvironment::new("youtube_processing").await.unwrap();
    env.create_user(123456789).unwrap();

    // User sends YouTube URL
    let message = env.user_message(123456789, "https://youtube.com/watch?v=test");

    // Process URL
    let result = handle_message(
        env.bot.clone(),
        message,
        env.download_queue.clone(),
        env.rate_limiter.clone(),
        env.db_pool.clone()
    ).await;

    assert!(result.is_ok());

    // Verify sequence:
    // 1. "Processing..." sent
    // 2. Preview with buttons sent
    // 3. Processing message deleted
    env.verify().await.unwrap();

    // Verify download queue state
    assert_eq!(env.download_queue.pending_count(), 1);
}
```

### Test: Settings change E2E

```rust
#[tokio::test]
async fn test_settings_change_quality_e2e() {
    let env = TestEnvironment::new("settings_quality_change").await.unwrap();
    env.create_user(123456789).unwrap();

    // 1. User opens settings
    let msg1 = env.user_message(123456789, "/settings");
    handle_settings_command(env.bot.clone(), msg1, env.db_pool.clone()).await.unwrap();

    // 2. User clicks "1080p"
    let callback = env.create_callback("settings:quality:1080");
    handle_settings_callback(env.bot.clone(), callback, env.db_pool.clone()).await.unwrap();

    // 3. Verify database updated
    let user = db::get_user(&env.db_pool, 123456789).unwrap().unwrap();
    assert_eq!(user.video_quality, "1080p");

    // 4. Verify UI updated
    env.verify().await.unwrap();
}
```

## üé® –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–µ–π–∫–æ–≤—ã—Ö Message –æ–±—ä–µ–∫—Ç–æ–≤

### –í–∞—Ä–∏–∞–Ω—Ç 1: JSON Deserialization

```rust
pub fn create_message_from_json(user_id: i64, text: &str) -> Message {
    let json = format!(r#"{{
        "message_id": 1,
        "date": 1234567890,
        "chat": {{"id": {}, "type": "private", "first_name": "Test"}},
        "from": {{"id": {}, "is_bot": false, "first_name": "Test"}},
        "text": "{}",
        "entities": []
    }}"#, user_id, user_id, text);

    serde_json::from_str(&json).expect("Failed to parse message JSON")
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: Builder Pattern

```rust
pub struct MessageBuilder {
    user_id: i64,
    chat_id: i64,
    text: String,
}

impl MessageBuilder {
    pub fn new(user_id: i64) -> Self {
        Self {
            user_id,
            chat_id: user_id,
            text: String::new(),
        }
    }

    pub fn text(mut self, text: impl Into<String>) -> Self {
        self.text = text.into();
        self
    }

    pub fn build(self) -> Message {
        create_message_from_json(self.user_id, &self.text)
    }
}

// Usage:
let msg = MessageBuilder::new(123).text("/start").build();
```

## üóÑÔ∏è Database Setup –¥–ª—è —Ç–µ—Å—Ç–æ–≤

```rust
// tests/common/test_db.rs

pub fn create_test_db_pool() -> anyhow::Result<Arc<DbPool>> {
    let pool = create_pool(":memory:")?;

    // Run migrations
    let mut conn = pool.get()?;
    refinery::embed_migrations!("migrations");
    migrations::runner().run(&mut conn)?;

    Ok(Arc::new(pool))
}

pub fn insert_test_user(pool: &DbPool, user_id: i64) -> anyhow::Result<()> {
    let conn = pool.get()?;
    conn.execute(
        "INSERT INTO users (telegram_id, language, video_quality, audio_bitrate)
         VALUES (?1, 'ru', '1080p', '192')",
        params![user_id],
    )?;
    Ok(())
}
```

## üß™ –ü–æ–ª–Ω—ã–π E2E Test Suite

```rust
// tests/e2e/mod.rs

mod test_commands;      // /start, /info, /settings
mod test_downloads;     // YouTube, SoundCloud
mod test_settings;      // Quality changes, language
mod test_rate_limiting; // Rate limits, upgrades
mod test_errors;        // Invalid URLs, network errors

// tests/e2e/test_commands.rs
mod common;
use common::TestEnvironment;

#[tokio::test]
async fn test_all_commands() {
    let commands = vec![
        ("start_command", "/start"),
        ("info_command", "/info"),
        ("settings_command", "/settings"),
    ];

    for (snapshot, command) in commands {
        println!("Testing: {}", command);

        let env = TestEnvironment::new(snapshot).await.unwrap();
        env.create_user(123456789).unwrap();

        let msg = env.user_message(123456789, command);
        let result = handle_command(env.bot.clone(), msg, env.db_pool.clone()).await;

        assert!(result.is_ok(), "{} should succeed", command);
        env.verify().await.unwrap();
    }
}
```

## üìä –ß—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤ E2E

### ‚úÖ API Calls
```rust
env.verify_api_calls(&[
    ("POST", "/sendMessage"),
    ("POST", "/sendPhoto"),
    ("POST", "/deleteMessage"),
]);
```

### ‚úÖ Database State
```rust
let user = db::get_user(&env.db_pool, user_id).unwrap().unwrap();
assert_eq!(user.video_quality, "1080p");
assert_eq!(user.downloads_count, 1);
```

### ‚úÖ Queue State
```rust
assert_eq!(env.download_queue.pending_count(), 1);
let task = env.download_queue.pop().await.unwrap();
assert_eq!(task.url, "https://youtube.com/...");
```

### ‚úÖ Cache State
```rust
let cached = cache::get(&env.cache, "preview:video_id").unwrap();
assert!(cached.is_some());
```

### ‚úÖ Rate Limiter
```rust
assert!(!env.rate_limiter.is_limited(user_id).await);
env.rate_limiter.record(user_id).await;
assert!(env.rate_limiter.is_limited(user_id).await);
```

## üöÄ –ó–∞–ø—É—Å–∫ E2E —Ç–µ—Å—Ç–æ–≤

```bash
# –í—Å–µ E2E —Ç–µ—Å—Ç—ã
cargo test --test e2e

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
cargo test --test e2e test_commands

# –° –≤—ã–≤–æ–¥–æ–º
cargo test --test e2e -- --nocapture

# –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–±—ã—Å—Ç—Ä–æ)
cargo test --test e2e -- --test-threads=4
```

## üìà –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ **–ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è** - –Ω–∏–∫–∞–∫–∏—Ö –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
‚úÖ **–ë—ã—Å—Ç—Ä–æ** - –Ω–µ—Ç —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
‚úÖ **–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ** - –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –í–°–Å** - –æ—Ç –∫–æ–º–∞–Ω–¥—ã –¥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ë–î
‚úÖ **CI/CD friendly** - –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –ª—é–±–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å** TestEnvironment –≤ `tests/common/fixtures.rs`
2. **–°–æ–∑–¥–∞—Ç—å** message builders –≤ `tests/common/builders.rs`
3. **–ù–∞–ø–∏—Å–∞—Ç—å** –ø–µ—Ä–≤—ã–π E2E —Ç–µ—Å—Ç –¥–ª—è `/start`
4. **–†–∞—Å—à–∏—Ä–∏—Ç—å** –Ω–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
5. **–î–æ–±–∞–≤–∏—Ç—å** –≤ CI pipeline

## üìö –°–º. —Ç–∞–∫–∂–µ

- [–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](../tests/e2e/) (–±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω)
- [SNAPSHOT_TESTING.md](SNAPSHOT_TESTING.md) - –±–∞–∑–∞ –¥–ª—è E2E
- [SNAPSHOT_TESTING_INTEGRATION.md](SNAPSHOT_TESTING_INTEGRATION.md) - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
