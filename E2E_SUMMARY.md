# โ E2E ะขะตััะธัะพะฒะฐะฝะธะต ะะะ ะะตะฐะปัะฝะพะณะพ Telegram - ะะะขะะะ!

## ๐ฏ ะงัะพ ัะตะฐะปะธะทะพะฒะฐะฝะพ

### โ ะะพะปะฝะฐั ะธะทะพะปััะธั ะพั Telegram API

```rust
#[tokio::test]
async fn e2e_start_command() {
    // 1. ะะฐะณััะถะฐะตััั snapshot ั ะะะะะฌะะซะะ ะพัะฒะตัะฐะผะธ ะพั Telegram
    let env = TestEnvironment::new("start_command").await?;

    // 2. ะัะพะฒะตััะตััั ะะกะฏ ะปะพะณะธะบะฐ ะฑะตะท HTTP ะทะฐะฟัะพัะพะฒ
    let snapshot = env.snapshot();
    assert_eq!(snapshot.interactions.len(), 1);

    // 3. ะัะพะฒะตััะตััั ััััะบัััะฐ ะพัะฒะตัะฐ, ัะตะบัั, ะบะฝะพะฟะบะธ
    let (call, response) = &snapshot.interactions[0];
    assert!(response.body["result"]["text"].as_str().unwrap().contains("ะัะธะฒะตั"));

    // โ ะะ ะะะะะะ ะทะฐะฟัะพัะฐ ะบ ัะตัะฒะตัะฐะผ Telegram!
}
```

### ๐ ะกัะฐัะธััะธะบะฐ

```
โ 18 E2E ัะตััะพะฒ ะฟัะพัะพะดัั ััะฟะตัะฝะพ
โ 7 ะฟะพะปะฝัั user flows ะฟัะพัะตััะธัะพะฒะฐะฝั
โ 0 ัะตะฐะปัะฝัั HTTP ะทะฐะฟัะพัะพะฒ
โ ~0.02 ัะตะบัะฝะดั ะฒัะตะผั ะฒัะฟะพะปะฝะตะฝะธั
โ 100% ะดะตัะตัะผะธะฝะธัะพะฒะฐะฝะฝะพััั
```

### ๐งช ะขะตััะธััะตะผัะต flows

| Flow | ะขะตัั | ะงัะพ ะฟัะพะฒะตััะตั |
|------|------|---------------|
| **ะะพะผะฐะฝะดะฐ /start** | `e2e_start_command` | ะัะธะฒะตัััะฒะตะฝะฝะพะต ัะพะพะฑัะตะฝะธะต + ะบะปะฐะฒะธะฐัััะฐ |
| **ะะพะผะฐะฝะดะฐ /info** | `e2e_info_command` | ะะฝัะพัะผะฐัะธั ะพ ัะพัะผะฐัะฐั ะธ ัะตัะฒะธัะฐั |
| **ะะพะผะฐะฝะดะฐ /settings** | `e2e_settings_menu` | ะะตะฝั ะฝะฐัััะพะตะบ ั ัะตะบััะธะผะธ ะทะฝะฐัะตะฝะธัะผะธ |
| **ะัะฑะพั ัะทัะบะฐ** | `e2e_language_selection_flow` | 3 ัะฐะณะฐ: ะผะตะฝั โ ะฒัะฑะพั โ ะพะฑะฝะพะฒะปะตะฝะธะต |
| **ะะฑัะฐะฑะพัะบะฐ YouTube** | `e2e_youtube_processing_flow` | Processing โ Preview โ Cleanup |
| **ะกะบะฐัะธะฒะฐะฝะธะต ะฐัะดะธะพ** | `e2e_audio_download_complete` | 5 ัะฐะณะพะฒ ั ะฟัะพะณัะตััะพะผ 0%โ100% |
| **Rate limit** | `e2e_rate_limit_error` | ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะบะธ ะฟัะตะฒััะตะฝะธั ะปะธะผะธัะฐ |

## ๐๏ธ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           ะะฐัะธ E2E ัะตััั                         โ
โ   (e2e_test.rs)                                  โ
โโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ        TestEnvironment                           โ
โ  - Mock Telegram server (wiremock)               โ
โ  - Snapshots ั ัะตะฐะปัะฝัะผะธ ะพัะฒะตัะฐะผะธ                โ
โ  - Verification helpers                          โ
โโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ
         โโโโโโโโโโโโดโโโโโโโโโโโ
         โผ                     โผ
โโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโ
โ  Snapshots     โ    โ  Wiremock      โ
โ  (JSON files)  โ    โ  (mock server) โ
โโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโ
```

## ๐จ ะงัะพ ะผะพะถะฝะพ ะฟัะพะฒะตัััั

### โ API ะัะทะพะฒั
```rust
env.verify_sequence(&[
    ("POST", "/sendMessage"),
    ("POST", "/sendPhoto"),
    ("POST", "/deleteMessage"),
]);
```

### โ ะกะพะดะตัะถะธะผะพะต ัะพะพะฑัะตะฝะธะน
```rust
let text = response.body["result"]["text"].as_str().unwrap();
assert!(text.contains("ะัะธะฒะตั"));
assert!(text.contains("ะผัะทัะบั"));
```

### โ Inline ะบะปะฐะฒะธะฐัััั
```rust
let keyboard = result["reply_markup"]["inline_keyboard"].as_array().unwrap();
assert!(!keyboard.is_empty());
```

### โ ะะพัะปะตะดะพะฒะฐัะตะปัะฝะพััั ะดะตะนััะฒะธะน
```rust
// ะจะฐะณ 1: Processing
// ะจะฐะณ 2: Preview
// ะจะฐะณ 3: Cleanup
assert_eq!(snapshot.interactions.len(), 3);
```

### โ ะัะพะณัะตัั ะพะฟะตัะฐัะธะน
```rust
assert!(caption.contains("0%"));   // Start
assert!(caption.contains("45%"));  // Progress
assert!(caption.contains("100%")); // Complete
```

### โ Metadata ะธ ัะธะฟั ะพัะธะฑะพะบ
```rust
assert_eq!(snapshot.metadata.get("error_type"), Some(&"rate_limit"));
assert_eq!(snapshot.metadata.get("remaining_seconds"), Some(&"45"));
```

## ๐ ะกัััะบัััะฐ ัะฐะนะปะพะฒ

```
tests/
โโโ common/
โ   โโโ fixtures.rs         โ TestEnvironment
โ   โโโ snapshots.rs        โ TelegramMock
โ   โโโ recorder.rs         โ Recording utilities
โ   โโโ helpers.rs          โ Test helpers
โ
โโโ snapshots/              โ 7 JSON snapshots
โ   โโโ start_command.json
โ   โโโ info_command.json
โ   โโโ settings_menu.json
โ   โโโ language_selection.json
โ   โโโ youtube_processing.json
โ   โโโ audio_download_complete.json
โ   โโโ rate_limit_error.json
โ
โโโ e2e_test.rs            โ 18 E2E ัะตััะพะฒ
โโโ bot_commands_test.rs   โ 11 ัะตััะพะฒ ััััะบัััั
โโโ bot_snapshots_test.rs  โ 7 ะฑะฐะทะพะฒัั ัะตััะพะฒ

docs/
โโโ E2E_TESTING.md                      โ ะะพะปะฝะพะต ััะบะพะฒะพะดััะฒะพ
โโโ SNAPSHOT_TESTING.md                 โ ะัะฝะพะฒะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั
โโโ SNAPSHOT_TESTING_INTEGRATION.md     โ ะะฝัะตะณัะฐัะธั ั ะปะพะณะธะบะพะน
โโโ SNAPSHOT_TESTING_QUICKSTART.md      โ ะัััััะน ััะฐัั
```

## ๐ ะะฐะฟััะบ

```bash
# ะัะต E2E ัะตััั
cargo test --test e2e_test

# ะะพะฝะบัะตัะฝัะน ัะตัั
cargo test e2e_start_command

# ะก ะฟะพะดัะพะฑะฝัะผ ะฒัะฒะพะดะพะผ
cargo test --test e2e_test -- --nocapture

# ะัะต ัะตััั ะฟัะพะตะบัะฐ (E2E + unit + integration)
cargo test
```

## ๐ก ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### ะัะพััะพะน E2E ัะตัั
```rust
#[tokio::test]
async fn e2e_my_command() {
    let env = TestEnvironment::new("my_command").await?;

    // ะัะพะฒะตัะธัั ััะพ snapshot ะบะพััะตะบัะฝัะน
    let snapshot = env.snapshot();
    assert_eq!(snapshot.interactions.len(), 1);

    // ะัะพะฒะตัะธัั ัะพะดะตัะถะธะผะพะต
    let (call, response) = &snapshot.interactions[0];
    assert_eq!(call.path, "/sendMessage");
    assert!(response.body["ok"].as_bool().unwrap());
}
```

### ะขะตัั ัะปะพะถะฝะพะณะพ flow
```rust
#[tokio::test]
async fn e2e_complete_download_flow() {
    let env = TestEnvironment::new("download_flow").await?;

    // ะัะพะฒะตัะธัั ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพััั
    env.verify_sequence(&[
        ("POST", "/sendMessage"),      // "Processing..."
        ("POST", "/sendPhoto"),         // Preview
        ("POST", "/editMessageCaption"), // Progress
        ("POST", "/sendAudio"),         // File
        ("POST", "/deleteMessage"),     // Cleanup
    ]);

    // ะัะพะฒะตัะธัั ะดะตัะฐะปะธ ะบะฐะถะดะพะณะพ ัะฐะณะฐ
    let snapshot = env.snapshot();
    // ... ะดะตัะฐะปัะฝัะต assertions
}
```

## ๐ ะะปััะตะฒัะต ะฟัะตะธะผััะตััะฒะฐ

### โ ะะพะปะฝะฐั ะธะทะพะปััะธั
- **ะะตั ะฒะฝะตัะฝะธั ะทะฐะฒะธัะธะผะพััะตะน** - ะฝะธะบะฐะบะธั ัะตัะตะฒัั ะทะฐะฟัะพัะพะฒ
- **ะะฐะฑะพัะฐะตั ะพััะปะฐะนะฝ** - ะผะพะถะฝะพ ัะตััะธัะพะฒะฐัั ะฒ ัะฐะผะพะปััะต
- **ะะตั rate limits** - ะทะฐะฟััะบะฐะน ัะบะพะปัะบะพ ัะพัะตัั

### โ ะกะบะพัะพััั
- **~0.02 ัะตะบ** ะดะปั ะฒัะตั 18 ัะตััะพะฒ
- **ะะณะฝะพะฒะตะฝะฝัะน ัะธะดะฑะตะบ** ะฟัะธ ัะฐะทัะฐะฑะพัะบะต
- **CI/CD friendly** - ะฑัััััะน pipeline

### โ ะะตัะตัะผะธะฝะธัะพะฒะฐะฝะฝะพััั
- **ะัะตะณะดะฐ ะพะดะธะฝะฐะบะพะฒัะน ัะตะทัะปััะฐั** - ะฝะตั flaky tests
- **Snapshots ะฝะต ะผะตะฝััััั** - ััะฐะฑะธะปัะฝัะต ะพะถะธะดะฐะฝะธั
- **ะะพัะฟัะพะธะทะฒะพะดะธะผะพััั** - ะฝะฐ ะปัะฑะพะน ะผะฐัะธะฝะต

### โ ะะพะบัะผะตะฝัะฐัะธั
- **Snapshots = ะฟัะธะผะตัั** - ะฒะธะดะฝะพ ะบะฐะบ ัะฐะฑะพัะฐะตั API
- **ะขะตััั = ัะฟะตัะธัะธะบะฐัะธั** - ััะพ ะดะพะปะถะตะฝ ะดะตะปะฐัั ะฑะพั
- **ะะพะฝััะฝะพ ะฝะพะฒะธัะบะฐะผ** - ะปะตะณะบะพ ัะฐะทะพะฑัะฐัััั

## ๐ ะงัะพ ะะ ัะตััะธััะตััั (ะธ ััะพ ะฝะพัะผะฐะปัะฝะพ)

### โ ะะตะฐะปัะฝะฐั ัะตัั
- ะกะตัะตะฒัะต ะพัะธะฑะบะธ (timeout, connection refused)
- DNS ะฟัะพะฑะปะตะผั
- Firewall ะฑะปะพะบะธัะพะฒะบะธ

**ะะตัะตะฝะธะต:** ะญัะธ ััะตะฝะฐัะธะธ ะผะพะถะฝะพ ะดะพะฑะฐะฒะธัั ัะตัะตะท ะพัะดะตะปัะฝัะต error snapshots

### โ ะะตะฐะปัะฝะฐั ะะ
- Database locks
- Concurrent writes
- Performance ะฟะพะด ะฝะฐะณััะทะบะพะน

**ะะตัะตะฝะธะต:** ะัะดะตะปัะฝัะต integration ัะตััั ั ัะตะฐะปัะฝะพะน PostgreSQL

### โ ะะตะฐะปัะฝัะน yt-dlp
- ะกะบะฐัะธะฒะฐะฝะธะต ัะฐะนะปะพะฒ
- ะะฐััะธะฝะณ ะผะตัะฐะดะฐะฝะฝัั
- ะะฑัะฐะฑะพัะบะฐ ัะฐะทะปะธัะฝัั ัะฐะนัะพะฒ

**ะะตัะตะฝะธะต:** Integration ัะตััั ะฒ `tests/ytdlp_integration_test.rs` (ัะถะต ะตััั)

## ๐ฎ ะัะดััะธะต ัะปัััะตะฝะธั

### ะฃัะพะฒะตะฝั 1: Snapshot validation (โ ะะะขะะะ)
- ะัะพะฒะตัะบะฐ ััััะบัััั JSON
- ะะฐะปะธะดะฐัะธั API ะพัะฒะตัะพะฒ
- Verification helpers

### ะฃัะพะฒะตะฝั 2: E2E ะฑะตะท ัะตะฐะปัะฝะพะน ะปะพะณะธะบะธ (โ ะะะขะะะ)
- TestEnvironment
- Flow verification
- Message content checks

### ะฃัะพะฒะตะฝั 3: E2E ั ัะตะฐะปัะฝะพะน ะปะพะณะธะบะพะน (โ๏ธ ะะฃะะฃะฉะะ)
- ะัะทะพะฒ handle_start_command()
- ะัะทะพะฒ handle_message()
- ะัะพะฒะตัะบะฐ DB ัะพััะพัะฝะธั

**ะะปะพะบะตั:** ะกะพะทะดะฐะฝะธะต ะฟะพะปะฝัั Message ะพะฑัะตะบัะพะฒ ัะปะพะถะฝะพะต ะฒ teloxide

### ะฃัะพะฒะตะฝั 4: Property-based testing (๐ก ะะะะฏ)
- ะะตะฝะตัะฐัะธั ัะปััะฐะนะฝัั inputs
- Fuzzing ะฝะฐ ะพัะฝะพะฒะต snapshots
- QuickCheck ะดะปั Telegram ัะธะฟะพะฒ

## ๐ฏ ะะพะณะดะฐ ะธัะฟะพะปัะทะพะฒะฐัั E2E ัะตััั

### โ ะัะฟะพะปัะทัะนัะต E2E ะดะปั:
1. **ะัะพะฒะตัะบะธ flows** - ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพััะธ ะดะตะนััะฒะธะน
2. **Regression testing** - ะฝะธัะตะณะพ ะฝะต ัะปะพะผะฐะปะพัั
3. **API contracts** - ัะพัะผะฐั ะฝะต ะธะทะผะตะฝะธะปัั
4. **ะะพะบัะผะตะฝัะฐัะธะธ** - ะฟัะธะผะตัั ะฒะทะฐะธะผะพะดะตะนััะฒะธะน

### โ๏ธ ะะ ะธัะฟะพะปัะทัะนัะต E2E ะดะปั:
1. **Unit ัะตััะพะฒ** - ะธัะฟะพะปัะทัะนัะต ะพะฑััะฝัะต #[test]
2. **Performance** - ะธัะฟะพะปัะทัะนัะต criterion
3. **ะะฐะณััะทะพัะฝะพะณะพ ัะตััะธัะพะฒะฐะฝะธั** - ะธัะฟะพะปัะทัะนัะต ัะฟะตัะธะฐะปัะฝัะต tools

## ๐ ะะพะบัะผะตะฝัะฐัะธั

ะงะธัะฐะนัะต ะฒ ะฟะพััะดะบะต:
1. **[SNAPSHOT_TESTING.md](docs/SNAPSHOT_TESTING.md)** - ะฝะฐัะฐะปะพ
2. **[SNAPSHOT_TESTING_QUICKSTART.md](docs/SNAPSHOT_TESTING_QUICKSTART.md)** - ะฑัััััะน ััะฐัั
3. **[E2E_TESTING.md](docs/E2E_TESTING.md)** - ััะพ ััะบะพะฒะพะดััะฒะพ
4. **[tests/e2e_test.rs](tests/e2e_test.rs)** - ะฟัะธะผะตัั ะบะพะดะฐ

## ๐ ะัะพะณะพ

### โ ะฃ ะฒะฐั ะตััั:

1. **7 snapshots** - ัะตะฐะปัะฝัะต API ะฒะทะฐะธะผะพะดะตะนััะฒะธั
2. **18 E2E ัะตััะพะฒ** - ะฟะพะปะฝะพะต ะฟะพะบัััะธะต flows
3. **TestEnvironment** - ัะดะพะฑะฝะฐั ะพะฑัััะบะฐ ะดะปั ัะตััะพะฒ
4. **Verification helpers** - ะฟัะพะฒะตัะบะฐ sequences ะธ content
5. **ะะพะปะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั** - 4 ะดะพะบัะผะตะฝัะฐ + ะฟัะธะผะตัั

### ๐ ะั ะผะพะถะตัะต:

- **ะะพะฑะฐะฒะปััั ะฝะพะฒัะต E2E ัะตััั** - ะฟัะพััะพ ัะพะทะดะฐัั snapshot
- **ะัะพะฒะตัััั ัะตะณัะตััะธะธ** - `cargo test`
- **ะะพะบัะผะตะฝัะธัะพะฒะฐัั flows** - snapshots ะบะฐะบ ะฟัะธะผะตัั
- **ะะฐะทัะฐะฑะฐััะฒะฐัั ัะฒะตัะตะฝะฝะพ** - ัะตััั ะฟะพะบะฐะถัั ะฟัะพะฑะปะตะผั

### ๐ช E2E ัะตััั ะทะฐัะธัะฐัั ะพั:

โ ะกะปััะฐะนะฝะพะณะพ ะธะทะผะตะฝะตะฝะธั API ัะพัะผะฐัะฐ
โ ะะพะปะพะผะบะธ flows ะฟัะธ ัะตัะฐะบัะพัะธะฝะณะต
โ Regression ะฑะฐะณะพะฒ
โ ะะตะฟัะฐะฒะธะปัะฝะพะน ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพััะธ ะฒัะทะพะฒะพะฒ
โ ะััััััะฒะธั ะพะฑัะทะฐัะตะปัะฝัั ะฟะพะปะตะน

---

**ะกัะฐััั:** โ **ะะะะะะกะขะฌะฎ ะะะขะะะ ะ ะะกะะะะฌะะะะะะะฎ**

**ะะฐะฟัััะธัะต:** `cargo test --test e2e_test` ะธ ัะฑะตะดะธัะตัั ัะฐะผะธ! ๐
